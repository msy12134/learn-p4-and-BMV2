# P4 ç¼–ç¨‹è¯¦è§£ï¼šæ„å»ºæ™ºèƒ½ç½‘ç»œçš„å®Œæ•´æŒ‡å—

## P4 ç¨‹åºè§£å‰–ï¼šä»å¤´åˆ°å°¾çš„æ·±åº¦ç†è§£ ğŸ”¬

P4 æ˜¯ä¸€ç§é¢†å…ˆçš„å¯ç¼–ç¨‹æ•°æ®å¹³é¢è¯­è¨€ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿç²¾ç¡®æ§åˆ¶ç½‘ç»œè®¾å¤‡å¦‚ä½•å¤„ç†æ•°æ®åŒ…ã€‚ä¸‹é¢æˆ‘ä»¬å°†æ·±å…¥å‰–æä¸€ä¸ªå®Œæ•´ P4 ç¨‹åºçš„æ¯ä¸ªç»„æˆéƒ¨åˆ†ã€‚

### 1. å¤´æ–‡ä»¶å¼•å…¥ - åŸºç¡€æ¨¡å—çš„è£…è½½ ğŸ“š

```p4
#include <core.p4>
#include <v1model.p4>
```

**è¯¦ç»†è§£é‡Š**ï¼š
- `core.p4`ï¼šæä¾› P4 è¯­è¨€çš„æ ¸å¿ƒå®šä¹‰ï¼ŒåŒ…æ‹¬åŸºæœ¬ç±»å‹ã€æ“ä½œç¬¦å’Œæ ‡å‡†æ³¨è§£
- `v1model.p4`ï¼šå®šä¹‰äº†é’ˆå¯¹ BMV2 (Behavioral Model version 2) çš„æ¶æ„æ¨¡å‹ï¼ŒåŒ…å«äº†è§£æå™¨ã€å…¥å£/å‡ºå£æ§åˆ¶å—ã€æ ¡éªŒå’Œè®¡ç®—ç­‰ç»„ä»¶çš„æ¥å£å®šä¹‰

è¿™ä¸¤ä¸ªå¤´æ–‡ä»¶ä¸ºä½ çš„ P4 ç¨‹åºæä¾›äº†åŸºç¡€æ¶æ„ï¼Œå°±åƒæ˜¯å»ºç­‘çš„åœ°åŸºå’Œæ¡†æ¶ã€‚æ²¡æœ‰å®ƒä»¬ï¼Œä½ å°†æ— æ³•ç¼–å†™åœ¨ BMV2 ä¸Šè¿è¡Œçš„ P4 ç¨‹åºã€‚

### 2. å¸¸é‡å®šä¹‰ - è¯­ä¹‰åŒ–çš„æ•°å€¼è¡¨ç¤º ğŸ”¢

```p4
#define MAX_PORTS 255

const bit<16> TYPE_IPV4 = 0x0800;
const bit<16> TYPE_IPV6 = 0x86dd;
const bit<16> TYPE_ARP = 0x0806;
```

**è¯¦ç»†è§£é‡Š**ï¼š
- `#define MAX_PORTS 255`ï¼šé¢„å¤„ç†å™¨å®ï¼Œå®šä¹‰äº†äº¤æ¢æœºçš„æœ€å¤§ç«¯å£æ•°é‡
- `const bit<16> TYPE_IPV4 = 0x0800`ï¼šä»¥å¤ªç½‘å¸§ç±»å‹å­—æ®µçš„å¸¸é‡ï¼Œè¡¨ç¤ºè¯¥å¸§æºå¸¦ IPv4 æ•°æ®åŒ…
- `const bit<16> TYPE_IPV6 = 0x86dd`ï¼šä»¥å¤ªç½‘å¸§ç±»å‹å­—æ®µçš„å¸¸é‡ï¼Œè¡¨ç¤ºè¯¥å¸§æºå¸¦ IPv6 æ•°æ®åŒ…
- `const bit<16> TYPE_ARP = 0x0806`ï¼šä»¥å¤ªç½‘å¸§ç±»å‹å­—æ®µçš„å¸¸é‡ï¼Œè¡¨ç¤ºè¯¥å¸§æºå¸¦ ARP æ•°æ®åŒ…

ä½¿ç”¨å¸¸é‡è€Œéç¡¬ç¼–ç å€¼æœ‰å¤šé‡å¥½å¤„ï¼šæé«˜ä»£ç å¯è¯»æ€§ã€é›†ä¸­ç®¡ç†ä½¿ä»£ç æ›´æ˜“ç»´æŠ¤ã€å…è®¸åœ¨ä¸€å¤„ä¿®æ”¹å½±å“æ‰€æœ‰å¼•ç”¨ä½ç½®ã€‚

### 3. å¤´éƒ¨å®šä¹‰ - æ•°æ®åŒ…ç»“æ„çš„è“å›¾ ğŸ“

```p4
header ethernet_t {
    bit<48> dstAddr;    // ç›®çš„ MAC åœ°å€
    bit<48> srcAddr;    // æº MAC åœ°å€
    bit<16> ether_type; // ä»¥å¤ªç½‘ç±»å‹å­—æ®µ
}

header ipv4_t {
    bit<4>  version;      // IP ç‰ˆæœ¬ï¼ˆIPv4 ä¸º 4ï¼‰
    bit<4>  ihl;          // IP å¤´éƒ¨é•¿åº¦ï¼ˆå•ä½ï¼š4 å­—èŠ‚ï¼‰
    bit<8>  diffserv;     // åŒºåˆ†æœåŠ¡å­—æ®µ
    bit<16> totalLen;     // æ•°æ®åŒ…æ€»é•¿åº¦
    bit<16> identification; // æ ‡è¯†å­—æ®µï¼Œç”¨äºåˆ†ç‰‡é‡ç»„
    bit<3>  flags;        // åˆ†ç‰‡æ ‡å¿—
    bit<13> fragOffset;   // åˆ†ç‰‡åç§»
    bit<8>  ttl;          // å­˜æ´»æ—¶é—´
    bit<8>  protocol;     // ä¸Šå±‚åè®®ï¼ˆTCP=6ï¼ŒUDP=17 ç­‰ï¼‰
    bit<16> hdrChecksum;  // å¤´éƒ¨æ ¡éªŒå’Œ
    bit<32> src_addr;     // æº IP åœ°å€
    bit<32> dst_addr;     // ç›®çš„ IP åœ°å€
}

header probe_header_t {
    bit<8> num_probe_data; // è®°å½•æ¢æµ‹åŒ…å·²é€šè¿‡çš„äº¤æ¢æœºæ•°é‡
}

// é›†æˆæ‰€æœ‰å¯èƒ½å‡ºç°çš„å¤´éƒ¨
struct headers {
    ethernet_t      ethernet;
    ipv4_t          ipv4;
    probe_header_t  probe_header;
}
```

**è¯¦ç»†è§£é‡Š**ï¼š
- æ¯ä¸ª `header` å®šä¹‰éƒ½ç²¾ç¡®åœ°æ˜ å°„åˆ°ç½‘ç»œåè®®æ ¼å¼ä¸­çš„å­—æ®µå¸ƒå±€
- `bit<N>` æŒ‡å®šäº†æ¯ä¸ªå­—æ®µçš„ç²¾ç¡®ä½å®½
- `ethernet_t` å®šä¹‰äº†æ ‡å‡†çš„ä»¥å¤ªç½‘å¸§å¤´éƒ¨ï¼ˆ14 å­—èŠ‚ï¼‰
- `ipv4_t` å®šä¹‰äº† IPv4 æ•°æ®åŒ…å¤´éƒ¨ï¼ˆ20 å­—èŠ‚ï¼Œä¸å«é€‰é¡¹ï¼‰
- `probe_header_t` æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å¤´éƒ¨ï¼Œç”¨äºç½‘ç»œæ¢æµ‹åŠŸèƒ½
- `struct headers` å°†æ‰€æœ‰å¯èƒ½çš„å¤´éƒ¨ç»„åˆåˆ°ä¸€ä¸ªç»“æ„ä¸­ï¼Œæ–¹ä¾¿åç»­å¤„ç†

å¤´éƒ¨å®šä¹‰æ˜¯ P4 ç¨‹åºçš„æ ¸å¿ƒï¼Œå› ä¸ºå®ƒä»¬ç›´æ¥æ˜ å°„åˆ°ç½‘ç»œåè®®æ ‡å‡†ï¼Œç¡®ä¿äº†æ•°æ®åŒ…çš„æ­£ç¡®è§£æå’Œå¤„ç†ã€‚

### 4. å…ƒæ•°æ®å®šä¹‰ - æ•°æ®åŒ…çš„éšå½¢åŠ©æ‰‹ ğŸ§©

```p4
struct metadata {
    bit<8>   num_segments;  // ç”¨äºè®¡ç®— SRv6 æ®µæ•°é‡
    bit<8>   trafficclass;  // æµé‡åˆ†ç±»ä¿¡æ¯
    bit<128> s1;            // SRv6 æ®µ 1
    bit<128> s2;            // SRv6 æ®µ 2
    bit<128> s3;            // SRv6 æ®µ 3
    bit<128> s4;            // SRv6 æ®µ 4
    bit<128> s5;            // SRv6 æ®µ 5
    bit<8>   remaining1;    // å‰©ä½™æ®µæ•°
    bit<8>   last_entry;    // æœ€åä¸€ä¸ªæ®µçš„ç´¢å¼•
}
```

**è¯¦ç»†è§£é‡Š**ï¼š
- å…ƒæ•°æ®æ˜¯ä¼´éšæ•°æ®åŒ…ä½†ä¸ä½œä¸ºæ•°æ®åŒ…ä¸€éƒ¨åˆ†å‘é€çš„ä¿¡æ¯
- å…ƒæ•°æ®åœ¨æ•°æ®åŒ…å¤„ç†æµç¨‹ä¸­ç”¨äºå­˜å‚¨ä¸´æ—¶çŠ¶æ€å’Œä¸­é—´ç»“æœ
- åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå…ƒæ•°æ®ä¸»è¦ç”¨äº SRv6ï¼ˆæ®µè·¯ç”± IPv6ï¼‰ç›¸å…³çš„å¤„ç†
- `num_segments` è®°å½• SRv6 è·¯å¾„ä¸­çš„æ®µæ•°é‡
- `s1` åˆ° `s5` å­˜å‚¨ SRv6 è·¯å¾„ä¸­çš„å„ä¸ªæ®µï¼ˆIPv6 åœ°å€ï¼‰
- `remaining1` å’Œ `last_entry` ç”¨äº SRv6 å¤„ç†è¿‡ç¨‹ä¸­çš„çŠ¶æ€è·Ÿè¸ª

å…ƒæ•°æ®æ˜¯ P4 ç¨‹åºçš„"è®°äº‹æœ¬"ï¼Œè®©ä½ å¯ä»¥ä¿å­˜å„ç§å¤„ç†çŠ¶æ€ï¼Œè€Œæ— éœ€ä¿®æ”¹æ•°æ®åŒ…æœ¬èº«ã€‚

### 5. è§£æå™¨ - æ•°æ®åŒ…ç»“æ„çš„è§£ç å™¨ ğŸ”

```p4
parser MyParser(packet_in pkt,
                out headers hdr,
                inout metadata meta,
                inout standard_metadata_t standard_metadata) {
    state start {
        transition parse_ethernet;
    }
    
    state parse_ethernet {
        pkt.extract(hdr.ethernet);
        transition select(hdr.ethernet.ether_type) {
            TYPE_IPV4: parse_ipv4;
            default: accept;
        }
    }
    
    state parse_ipv4 {
        pkt.extract(hdr.ipv4);
        transition select(hdr.ipv4.protocol) {
            // æ ¹æ®åè®®ç±»å‹å†³å®šä¸‹ä¸€æ­¥è§£æ
            default: accept;
        }
    }
}

control MyVerifyChecksum(inout headers hdr, inout metadata meta) {
    apply {
        // æ ¡éªŒå’ŒéªŒè¯é€»è¾‘
        // é€šå¸¸ç”¨äºæ£€æŸ¥æ”¶åˆ°çš„ IP æ•°æ®åŒ…æ ¡éªŒå’Œæ˜¯å¦æ­£ç¡®
        verify_checksum(
            hdr.ipv4.isValid(),
            {
                hdr.ipv4.version,
                hdr.ipv4.ihl,
                hdr.ipv4.diffserv,
                hdr.ipv4.totalLen,
                hdr.ipv4.identification,
                hdr.ipv4.flags,
                hdr.ipv4.fragOffset,
                hdr.ipv4.ttl,
                hdr.ipv4.protocol,
                hdr.ipv4.src_addr,
                hdr.ipv4.dst_addr
            },
            hdr.ipv4.hdrChecksum,
            HashAlgorithm.csum16
        );
    }
}
```

**è¯¦ç»†è§£é‡Š**ï¼š
- **è§£æå™¨å‚æ•°**ï¼š
  - `packet_in pkt`ï¼šè¾“å…¥çš„æ•°æ®åŒ…
  - `out headers hdr`ï¼šæå–çš„å¤´éƒ¨å­˜å‚¨ä½ç½®
  - `inout metadata meta`ï¼šå¯è¯»å†™çš„å…ƒæ•°æ®
  - `inout standard_metadata_t standard_metadata`ï¼šç³»ç»Ÿæä¾›çš„æ ‡å‡†å…ƒæ•°æ®

- **è§£æçŠ¶æ€æœº**ï¼š
  - `state start`ï¼šè§£æçš„èµ·å§‹çŠ¶æ€ï¼Œæ‰€æœ‰æ•°æ®åŒ…ä»è¿™é‡Œå¼€å§‹
  - `transition parse_ethernet`ï¼šè½¬ç§»åˆ°è§£æä»¥å¤ªç½‘å¤´éƒ¨çš„çŠ¶æ€
  - `pkt.extract(hdr.ethernet)`ï¼šä»æ•°æ®åŒ…ä¸­æå–ä»¥å¤ªç½‘å¤´éƒ¨
  - `transition select(...)`ï¼šåŸºäºä»¥å¤ªç½‘ç±»å‹å­—æ®µå€¼ï¼Œé€‰æ‹©ä¸‹ä¸€ä¸ªè§£æçŠ¶æ€
  - è§£æå™¨ä½¿ç”¨ç±»ä¼¼çŠ¶æ€æœºçš„æ–¹å¼ï¼Œé€å±‚å‰¥ç¦»å¹¶è§£ææ•°æ®åŒ…çš„å„ä¸ªå±‚æ¬¡å¤´éƒ¨

- **æ ¡éªŒå’ŒéªŒè¯**ï¼š
  - `MyVerifyChecksum` æ§åˆ¶å—ç”¨äºéªŒè¯æ¥æ”¶æ•°æ®åŒ…çš„å¤´éƒ¨æ ¡éªŒå’Œ
  - `verify_checksum` æ˜¯å†…ç½®å‡½æ•°ï¼Œç”¨äºæ ¡éªŒå’Œè®¡ç®—å’ŒéªŒè¯

è§£æå™¨å°†è¾“å…¥çš„äºŒè¿›åˆ¶æ•°æ®åŒ…è½¬æ¢ä¸ºç»“æ„åŒ–çš„å¤´éƒ¨å­—æ®µï¼Œè¿™æ˜¯åç»­å¤„ç†çš„åŸºç¡€ã€‚

### 6. å…¥å£å¤„ç† - æ•°æ®åŒ…å¤„ç†çš„æ ¸å¿ƒå¼•æ“ âš™ï¸

```p4
control MyIngress(inout headers hdr,
                  inout metadata meta,
                  inout standard_metadata_t standard_metadata) {
    
    // å¯„å­˜å™¨å®šä¹‰ï¼šç”¨äºå­˜å‚¨æ¯ä¸ªç«¯å£ä¸Šæ¬¡æ¥æ”¶æ•°æ®åŒ…çš„æ—¶é—´æˆ³
    register<bit<48>>(MAX_PORTS) last_time_reg;
    
    // IPv6 è½¬å‘åŠ¨ä½œ
    action ipv6_forward(bit<48> dstAddr, bit<9> port) {
        // è®¾ç½®å‡ºå£ç«¯å£
        standard_metadata.egress_spec = port;
        // æ›´æ–°ä»¥å¤ªç½‘æºåœ°å€å’Œç›®çš„åœ°å€
        hdr.ethernet.srcAddr = hdr.ethernet.dstAddr;
        hdr.ethernet.dstAddr = dstAddr;
        // å‡å°‘ TTL
        hdr.ipv6.hop_limit = hdr.ipv6.hop_limit - 1;
    }
    
    // ä¸¢å¼ƒæ•°æ®åŒ…åŠ¨ä½œ
    action drop() {
        mark_to_drop(standard_metadata);
    }
    
    // IPv6 è·¯ç”±è¡¨
    table ipv6_lpm {
        key = {
            hdr.ipv6.dst_addr: exact;  // ç²¾ç¡®åŒ¹é…ç›®çš„ IPv6 åœ°å€
        }
        actions = {
            ipv6_forward;  // è½¬å‘åŠ¨ä½œ
            drop;          // ä¸¢å¼ƒåŠ¨ä½œ
        }
        size = 1024;       // è¡¨é¡¹æœ€å¤§æ•°é‡
        default_action = drop;  // é»˜è®¤åŠ¨ä½œæ˜¯ä¸¢å¼ƒ
    }
    
    apply {
        // å…¥å£å¤„ç†é€»è¾‘
        if (hdr.ipv6.isValid()) {
            // å¦‚æœæ˜¯ IPv6 æ•°æ®åŒ…ï¼Œåº”ç”¨è·¯ç”±è¡¨
            ipv6_lpm.apply();
        } else if (hdr.ipv4.isValid()) {
            // IPv4 å¤„ç†é€»è¾‘
            // ...
        }
        
        // æ—¶é—´æˆ³è®°å½•ç¤ºä¾‹
        bit<48> now = standard_metadata.ingress_global_timestamp;
        bit<9> ingress_port = standard_metadata.ingress_port;
        bit<48> last_time;
        
        // è¯»å–ä¸Šä¸€æ¬¡æ—¶é—´æˆ³
        last_time_reg.read(last_time, (bit<32>)ingress_port);
        // æ›´æ–°æ—¶é—´æˆ³
        last_time_reg.write((bit<32>)ingress_port, now);
    }
}
```

**è¯¦ç»†è§£é‡Š**ï¼š
- **å¯„å­˜å™¨å®šä¹‰**ï¼š
  - `register<bit<48>>(MAX_PORTS) last_time_reg`ï¼šåˆ›å»ºä¸€ä¸ªå¯„å­˜å™¨æ•°ç»„ï¼Œæ¯ä¸ªç«¯å£ä¸€ä¸ªå…ƒç´ ï¼Œå­˜å‚¨ 48 ä½æ—¶é—´æˆ³

- **åŠ¨ä½œå®šä¹‰**ï¼š
  - `ipv6_forward`ï¼šå®šä¹‰ IPv6 æ•°æ®åŒ…è½¬å‘çš„å…·ä½“æ­¥éª¤
    - è®¾ç½®å‡ºå£ç«¯å£
    - æ›´æ–° MAC åœ°å€ï¼ˆé€šå¸¸æ˜¯è®¾ç½®ä¸ºä¸‹ä¸€è·³çš„ MAC åœ°å€ï¼‰
    - å‡å°‘è·³æ•°é™åˆ¶ï¼ˆç±»ä¼¼ IPv4 çš„ TTLï¼‰
  - `drop`ï¼šä¸¢å¼ƒæ•°æ®åŒ…çš„åŠ¨ä½œï¼Œæ˜¯ç½‘ç»œè®¾å¤‡å¸¸ç”¨çš„åŸºæœ¬æ“ä½œ

- **è¡¨å®šä¹‰**ï¼š
  - `ipv6_lpm`ï¼šIPv6 è·¯ç”±è¡¨ï¼Œæ ¹æ®ç›®çš„åœ°å€æŸ¥æ‰¾è½¬å‘è§„åˆ™
  - `key`ï¼šå®šä¹‰åŒ¹é…å­—æ®µï¼ˆè¿™é‡Œæ˜¯ç›®çš„ IPv6 åœ°å€ï¼‰
  - `actions`ï¼šå¯èƒ½çš„åŠ¨ä½œåˆ—è¡¨ï¼ˆè½¬å‘æˆ–ä¸¢å¼ƒï¼‰
  - `size`ï¼šè¡¨çš„æœ€å¤§å®¹é‡
  - `default_action`ï¼šæœªåŒ¹é…æ—¶çš„é»˜è®¤åŠ¨ä½œ

- **åº”ç”¨é€»è¾‘**ï¼š
  - `apply` å—åŒ…å«äº†å®é™…çš„å¤„ç†æµç¨‹
  - æ ¹æ®å¤´éƒ¨æœ‰æ•ˆæ€§åˆ¤æ–­æ•°æ®åŒ…ç±»å‹
  - åº”ç”¨ç›¸åº”çš„è¡¨æ¥è·å–å¤„ç†å†³ç­–
  - ä½¿ç”¨å¯„å­˜å™¨è®°å½•å’Œæ›´æ–°æ—¶é—´æˆ³ä¿¡æ¯

å…¥å£å¤„ç†æ˜¯ P4 ç¨‹åºçš„å†³ç­–ä¸­å¿ƒï¼Œå®ƒå®šä¹‰äº†æ•°æ®åŒ…å¦‚ä½•è¢«åˆ†ç±»ã€ä¿®æ”¹å’Œè½¬å‘ã€‚

### 7. å‡ºå£å¤„ç† - æ•°æ®åŒ…çš„æœ€ç»ˆåŠ å·¥ç«™ ğŸ”§

```p4
control MyEgress(inout headers hdr,
                 inout metadata meta,
                 inout standard_metadata_t standard_metadata) {
    apply {
        // å‡ºå£å¤„ç†é€»è¾‘
        if (standard_metadata.egress_port == 1 && hdr.ipv4.isValid()) {
            // å¯¹å‘å¾€ç«¯å£ 1 çš„ IPv4 æ•°æ®åŒ…è¿›è¡Œç‰¹æ®Šå¤„ç†
            hdr.ipv4.ttl = hdr.ipv4.ttl - 1;  // é¢å¤–å‡å°‘ TTL
        }
        
        // å¤šæ’­å¤„ç†ç¤ºä¾‹
        if (standard_metadata.mcast_grp > 0) {
            // å¤„ç†å¤šæ’­å¤åˆ¶çš„æ•°æ®åŒ…
            // ...
        }
        
        // QoS æ ‡è®°ç¤ºä¾‹
        if (meta.trafficclass == 1) {
            // é«˜ä¼˜å…ˆçº§æµé‡
            hdr.ipv4.diffserv = 46;  // EF (Expedited Forwarding)
        }
    }
}
```

**è¯¦ç»†è§£é‡Š**ï¼š
- å‡ºå£å¤„ç†å‘ç”Ÿåœ¨å…¥å£å¤„ç†ä¹‹åï¼Œæ•°æ®åŒ…è¢«åˆ†é…åˆ°å‡ºå£ç«¯å£ä¹‹å
- å¯ä»¥åŸºäºå‡ºå£ç«¯å£ã€å¤šæ’­ç»„ã€æµé‡ç±»å‹ç­‰æ¡ä»¶è¿›è¡Œå¤„ç†
- å…¸å‹ç”¨é€”åŒ…æ‹¬ï¼š
  - ç«¯å£ç‰¹å®šçš„å¤„ç†ï¼ˆå¦‚ç¤ºä¾‹ä¸­çš„ç«¯å£ 1 ç‰¹æ®Šå¤„ç†ï¼‰
  - å¤šæ’­æ•°æ®åŒ…å¤„ç†
  - QoS æ ‡è®°è®¾ç½®ï¼ˆå¦‚å·®åˆ†æœåŠ¡å­—æ®µï¼‰
  - æµé‡æ•´å½¢å’Œé€Ÿç‡é™åˆ¶
  - æœ€ç»ˆçš„å¤´éƒ¨ä¿®æ”¹

å‡ºå£å¤„ç†è®©ä½ èƒ½å¤Ÿæ ¹æ®è¾“å‡ºæƒ…å†µå¯¹æ•°æ®åŒ…è¿›è¡Œæœ€åè°ƒæ•´ï¼Œç¡®ä¿å®ƒä»¬ä»¥æ­£ç¡®çš„å½¢å¼å‘é€å‡ºå»ã€‚

### 8. æ ¡éªŒå’Œè®¡ç®— - æ•°æ®å®Œæ•´æ€§çš„å®ˆå«è€… ğŸ›¡ï¸

```p4
control MyComputeChecksum(inout headers hdr, inout metadata meta) {
    apply {
        update_checksum(
            hdr.ipv4.isValid(),
            {
                hdr.ipv4.version,
                hdr.ipv4.ihl,
                hdr.ipv4.diffserv,
                hdr.ipv4.totalLen,
                hdr.ipv4.identification,
                hdr.ipv4.flags,
                hdr.ipv4.fragOffset,
                hdr.ipv4.ttl,
                hdr.ipv4.protocol,
                hdr.ipv4.src_addr,
                hdr.ipv4.dst_addr
            },
            hdr.ipv4.hdrChecksum,
            HashAlgorithm.csum16
        );
    }
}
```

**è¯¦ç»†è§£é‡Š**ï¼š
- æ ¡éªŒå’Œè®¡ç®—æ§åˆ¶å—è´Ÿè´£æ›´æ–°ä¿®æ”¹è¿‡çš„å¤´éƒ¨çš„æ ¡éªŒå’Œå­—æ®µ
- å½“ä½ åœ¨å…¥å£/å‡ºå£å¤„ç†ä¸­ä¿®æ”¹äº† IP å¤´éƒ¨ï¼ˆå¦‚æ”¹å˜ TTLï¼‰æ—¶ï¼Œéœ€è¦é‡æ–°è®¡ç®—æ ¡éªŒå’Œ
- `update_checksum` æ˜¯å†…ç½®å‡½æ•°ï¼Œç”¨äºè®¡ç®—å¹¶æ›´æ–°æ ¡éªŒå’Œ
- å‚æ•°åŒ…æ‹¬ï¼š
  - æ¡ä»¶ï¼ˆåªæœ‰å½“ IPv4 å¤´éƒ¨æœ‰æ•ˆæ—¶æ‰è®¡ç®—ï¼‰
  - å‚ä¸è®¡ç®—çš„å­—æ®µåˆ—è¡¨
  - å­˜å‚¨ç»“æœçš„å­—æ®µ
  - ä½¿ç”¨çš„æ•£åˆ—ç®—æ³•ï¼ˆé€šå¸¸æ˜¯ csum16ï¼‰

æ­£ç¡®çš„æ ¡éªŒå’Œè®¡ç®—ç¡®ä¿äº†ä¿®æ”¹åçš„æ•°æ®åŒ…ä¸ä¼šè¢«ä¸‹ä¸€è·³è·¯ç”±å™¨å› æ ¡éªŒå’Œé”™è¯¯è€Œä¸¢å¼ƒã€‚

### 9. åè§£æå™¨ - æ•°æ®åŒ…çš„é‡æ–°ç»„è£…å·¥å‚ ğŸ“¦

```p4
control MyDeparser(packet_out packet, in headers hdr) {
    apply {
        // æŒ‰ç…§åè®®å±‚æ¬¡é¡ºåºå‘é€å„ä¸ªå¤´éƒ¨
        packet.emit(hdr.ethernet);
        packet.emit(hdr.ipv4);
        packet.emit(hdr.probe_header);
        // å¯å˜é•¿åº¦çš„å¤´éƒ¨æˆ–é€‰é¡¹
        if (hdr.ipv4_options.isValid()) {
            packet.emit(hdr.ipv4_options);
        }
    }
}
```

**è¯¦ç»†è§£é‡Š**ï¼š
- åè§£æå™¨çš„ä»»åŠ¡æ˜¯å°†å¤„ç†åçš„å¤´éƒ¨é‡æ–°ç»„è£…æˆæ•°æ®åŒ…
- `packet.emit()` æŒ‰é¡ºåºå°†å¤´éƒ¨æ·»åŠ åˆ°è¾“å‡ºæ•°æ®åŒ…ä¸­
- å¤´éƒ¨å‘é€çš„é¡ºåºå¿…é¡»ç¬¦åˆåè®®è§„èŒƒï¼ˆå¦‚ä»¥å¤ªç½‘å¤´éƒ¨å¿…é¡»åœ¨ IP å¤´éƒ¨ä¹‹å‰ï¼‰
- å¯ä»¥æœ‰æ¡ä»¶åœ°å‘é€æŸäº›å¤´éƒ¨ï¼ˆå¦‚ç¤ºä¾‹ä¸­çš„ IP é€‰é¡¹ï¼‰
- å¦‚æœå¤´éƒ¨åœ¨å¤„ç†è¿‡ç¨‹ä¸­è¢«è®¾ä¸ºæ— æ•ˆï¼ˆ`setInvalid()`ï¼‰ï¼Œåˆ™ä¸ä¼šè¢«å‘é€

åè§£æå™¨ç¡®ä¿äº†ä¿®æ”¹åçš„æ•°æ®åŒ…å…·æœ‰æ­£ç¡®çš„æ ¼å¼ï¼Œå¯ä»¥è¢«ç½‘ç»œä¸­çš„å…¶ä»–è®¾å¤‡æ­£ç¡®ç†è§£ã€‚

### 10. ä¸»ç¨‹åº - å®Œæ•´æµæ°´çº¿çš„ç»„è£… ğŸ”„

```p4
V1Switch(
    MyParser(),
    MyVerifyChecksum(),
    MyIngress(),
    MyEgress(),
    MyComputeChecksum(),
    MyDeparser()
) main;
```

**è¯¦ç»†è§£é‡Š**ï¼š
- `V1Switch` æ˜¯ BMV2 æ¶æ„å®šä¹‰çš„æ ‡å‡†äº¤æ¢æœºæ¨¡å‹
- å®ƒå°†æ‰€æœ‰æ§åˆ¶å—ç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„å¤„ç†æµæ°´çº¿
- æ•°æ®åŒ…æŒ‰ç…§ä¸‹åˆ—é¡ºåºé€šè¿‡è¿™äº›é˜¶æ®µï¼š
  1. `MyParser`ï¼šè§£æè¾“å…¥æ•°æ®åŒ…
  2. `MyVerifyChecksum`ï¼šéªŒè¯æ ¡éªŒå’Œ
  3. `MyIngress`ï¼šå…¥å£å¤„ç†ï¼ˆä¸»è¦å†³ç­–é€»è¾‘ï¼‰
  4. `MyEgress`ï¼šå‡ºå£å¤„ç†
  5. `MyComputeChecksum`ï¼šæ›´æ–°æ ¡éªŒå’Œ
  6. `MyDeparser`ï¼šé‡æ–°ç»„è£…æ•°æ®åŒ…
- `main` æ ‡è¯†è¿™æ˜¯ç¨‹åºå…¥å£ç‚¹

è¿™ä¸ªç»“æ„å®šä¹‰äº†æ•°æ®åŒ…å¤„ç†çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œä»æ¥æ”¶åˆ°å‘é€çš„æ¯ä¸€æ­¥ã€‚

---

## æ·±å…¥ç†è§£ P4 çš„ä»·å€¼ ğŸ’

P4 ç¼–ç¨‹çš„å¼ºå¤§ä¹‹å¤„åœ¨äºå®ƒå°†ç½‘ç»œè®¾å¤‡çš„æ•°æ®å¹³é¢å®Œå…¨å¼€æ”¾ç»™äº†ç¨‹åºå‘˜ã€‚é€šè¿‡ç²¾ç¡®æ§åˆ¶æ•°æ®åŒ…çš„è§£æã€å¤„ç†å’Œè½¬å‘è¿‡ç¨‹ï¼Œä½ å¯ä»¥ï¼š

- å®ç°è‡ªå®šä¹‰åè®®ï¼Œè€Œæ— éœ€ç­‰å¾…ç¡¬ä»¶æ”¯æŒ
- å¼€å‘æ–°å‹ç½‘ç»œåŠŸèƒ½ï¼Œå¦‚é«˜çº§è´Ÿè½½å‡è¡¡ã€DDoS é˜²å¾¡
- åˆ›å»ºç²¾ç»†çš„æµé‡ç›‘æ§å’Œåˆ†æç³»ç»Ÿ
- æ„å»ºçµæ´»çš„ç½‘ç»œè™šæ‹ŸåŒ–è§£å†³æ–¹æ¡ˆ
- é™ä½ç½‘ç»œè®¾å¤‡çš„æ›´æ–°æˆæœ¬ï¼Œé€šè¿‡è½¯ä»¶æ›´æ–°å®ç°æ–°åŠŸèƒ½

åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸¤ä¸ªå®é™…æ¡ˆä¾‹å±•ç¤º P4 çš„åº”ç”¨ï¼šSRv6 åˆ†æ®µè·¯ç”±å’Œé“¾è·¯ç›‘æ§ã€‚è¿™äº›ä¾‹å­å°†å¸®åŠ©ä½ å°†æœ¬ç« å­¦åˆ°çš„æ¦‚å¿µåº”ç”¨åˆ°å®é™…é—®é¢˜ä¸­ï¼

---

> **åŠ¨æ‰‹æç¤º**ï¼šå°è¯•å°†è¿™äº›æ¦‚å¿µä¸ä½ å·²çŸ¥çš„ç½‘ç»œçŸ¥è¯†è”ç³»èµ·æ¥ã€‚ä¾‹å¦‚ï¼Œæ€è€ƒä¼ ç»Ÿäº¤æ¢æœº/è·¯ç”±å™¨å¦‚ä½•å®ç°è¿™äº›åŠŸèƒ½ï¼Œä»¥åŠ P4 å¦‚ä½•è®©ä½ ä»¥ä¸åŒæ–¹å¼å®ç°å®ƒä»¬ã€‚